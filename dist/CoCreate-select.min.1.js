/* CoCreateJS */
function initCoCreateSelects(e){const t=e||document;if(!t.querySelectorAll)return;let l=t.querySelectorAll("cocreate-select");console.log("Init Select ",l);for(let e=0;e<l.length;e++){initSelect(l[e])}}function initCoCreateSelectSockets(){CoCreateSocket.listen("getDocument",function(e){fetchedCoCreateSelectData(e)}),CoCreateSocket.listen("readDocument",function(e){fetchedCoCreateSelectData(e)}),CoCreateSocket.listen("updateDocument",function(e){fetchedCoCreateSelectData(e,!0)})}function initSortForSelect(){try{if(SortableOBJs)for(let e=0;e<SortableOBJs.length;e++){let t=SortableOBJs[e];Sortable.utils.on(t.el,"sort",function(e){void 0!==e.to.tagName&&"cocreate-select"==e.to.tagName.toLowerCase()&&saveSelect(e.to);let t=new CustomEvent("selectedValue");e.to.dispatchEvent(t)})}}catch(e){}}function initSelect(e){if(CoCreateUtils.getInitialized(e))return;CoCreateUtils.setInitialized(e);let t=e.querySelector("input");console.log("InitSelect",t);let l=e.querySelector("ul.selectable--list"),c=e.querySelectorAll(".template-wrapper"),a=e.querySelectorAll(".template-wrapper-array");t&&(t.addEventListener("click",function(t){this.focus(),l.classList.contains("open")||openSelectDropDown(e)}),t.addEventListener("keydown",function(t){let l=t.keyCode;if(13==l&&this.value.length>0){selectValueForSelect(this.value,e),saveSelect(e);let t=new CustomEvent("selectedValue");e.dispatchEvent(t),this.value=""}else if(8==l&&!this.value.length){let t=e.querySelectorAll(".selected");if(t.length>0){t[t.length-1].remove(),saveSelect(e);let l=new CustomEvent("selectedValue");e.dispatchEvent(l)}}}),t.addEventListener("focusout",function(t){setTimeout(()=>{closeSelectDropDown(e)},200)})),t.addEventListener("keyup",function(e){if(this.classList.contains("option-search")&&l){filterSelectorOptions(l.querySelectorAll(".selectable"),this.value)}}),l.addEventListener("click",function(t){if(!t.target.matches("li")){let l=t.target;for(console.log(l);void 0!==l.tagName&&"li"!=l.tagName.toLowerCase();)l=l.parentNode;if(l.classList&&l.classList.contains("selectable")){let t=l.getAttribute("data-value"),c=getSelectValue(e);if(t==c||c.indexOf(t)>-1)return;selectItemForSelect(l,e),saveSelect(e);let a=new CustomEvent("selectedValue");e.dispatchEvent(a)}}}),e.addEventListener("click",function(t){if(t.target.matches(".remove")){t.target.parentNode.remove(),saveSelect(e);let l=new CustomEvent("selectedValue");e.dispatchEvent(l)}else l.classList.contains("open")||openSelectDropDown(e)},!0);for(let t=0;t<c.length;t++){initSelectTemplateWrapper(c[t],e)}for(let t=0;t<a.length;t++)initFATemplateWrapper(a[t],e);function o(e){const t=getSelectValue(e),l=e.getAttribute("data-collection")||"module_activity",c=e.getAttribute("data-document_id"),a=e.getAttribute("name");"false"!=e.getAttribute("data-save_value")&&CoCreate.updateDocument({collection:l,document_id:c,data:{[a]:t},metadata:""})}e.addEventListener("clicked-submitBtn",function(){o(this)}),e.addEventListener("set-document_id",function(){o(this)}),fetchValuesForSelect(e)}function openSelectDropDown(e){let t=e.querySelector("input"),l=e.querySelector("ul.selectable--list");t&&(t.classList.add("open"),t.focus()),l&&l.classList.add("open");let c=new CustomEvent("open");e.dispatchEvent(c)}function closeSelectDropDown(e){let t=e.querySelector("input"),l=e.querySelector("ul.selectable--list");t&&t.classList.remove("open"),l&&l.classList.remove("open");let c=new CustomEvent("close");e.dispatchEvent(c)}function fetchValuesForSelect(e){let t=e.getAttribute("data-collection")||"module_activity",l=e.getAttribute("data-document_id");t&&l&&CoCreate.getDocument({collection:t,document_id:l})}function initSelectTemplateWrapper(e,t){e.addEventListener("fetchedTemplate",function(e){this.getAttribute("data-fetch_collection")&&this.getAttribute("data-fetch_collection");let l=this.querySelectorAll(".selectable");for(let e=0;e<l.length;e++){let t=l[e],c=t.getAttribute("data-document_id");c&&t.setAttribute("data-value",c)}fetchValuesForSelect(t)})}function initFATemplateWrapper(e,t){e.addEventListener("fetchedArray",function(e){console.log("fetched array");let l=this.querySelectorAll(".selectable");for(let e=0;e<l.length;e++){let t=l[e],c=(t.getAttribute("data-collection")&&t.getAttribute("data-collection"),t.getAttribute("data-document_id"));c&&t.setAttribute("data-value",c)}fetchValuesForSelect(t)})}function saveSelect(e){let t=getSelectValue(e),l=e.getAttribute("data-collection")||"module_activity",c=e.getAttribute("data-document_id"),a=e.getAttribute("name"),o=e.getAttribute("data-realtime")||!0;if(a&&"true"==o)if(CoCreateDocument.checkID(e)){if(c){if("false"==e.getAttribute("data-save_value"))return;CoCreate.updateDocument({collection:l,document_id:c,data:{[a]:t},metadata:""})}}else CoCreateDocument.requestDocumentId(e,"name",t),e.setAttribute("data-document_id","pending")}function fetchedCoCreateSelectData(e,t){let l=document.querySelectorAll("cocreate-select"),c=!1,a=[];for(let t=0;t<l.length;t++){let r=l[t];var o=r.getAttribute("data-collection")?r.getAttribute("data-collection"):"module_activity",i=r.getAttribute("data-document_id"),n=r.getAttribute("name");if(e.collection==o&&e.document_id==i&&n){let t=showValueInSelect(r,e.data[n]);a=a.concat(t),e.data[n]&&(c=!0)}}if(t&&c){let e=[];for(var r=0;r<a.length;r++)a[r]&&(e.includes[a[r]]||(e.push(a[r]),CoCreate.getDocument({collection:a[r].collection,document_id:a[r].id})))}}function showValueInSelect(e,t){if(!t)return;let l=e.querySelectorAll(".selected");for(let e=0;e<l.length;e++)l[e].remove();e.querySelector("input");let c=e.querySelector("ul.selectable--list"),a=[];if(t&&"object"==typeof t)for(let l=0;l<t.length;l++){let o=t[l];if(c.querySelector(".template")){let t=c.querySelector(".template"),l=c.getAttribute("data-pass_to"),i=c.getAttribute("data-fetch_collection");selectItemForSelect(getSelectItemTemplate(t,o,l,i),e),a.push({id:o,collection:i})}else if(c.querySelector("li[data-value='"+o+"']")){selectItemForSelect(c.querySelector("li[data-value='"+o+"']"),e)}else selectValueForSelect(o,e)}else if(t)if(c.querySelector(".template")){let l=c.querySelector(".template"),o=c.getAttribute("data-pass_to"),i=c.getAttribute("data-fetch_collection");selectItemForSelect(getSelectItemTemplate(l,t,o,i),e),a.push({id:t,collection:i})}else if(c.querySelector("li[data-value='"+t+"']")){selectItemForSelect(c.querySelector("li[data-value='"+t+"']"),e)}else selectValueForSelect(t,e);try{updateFloatLabel(e,t&&t.length>0)}catch(e){}return a}function getSelectItemTemplate(e,t,l,c){if(!e)return null;(e=e.cloneNode(!0)).removeAttribute("id"),e.classList.remove("template"),e.setAttribute("data-value",t);let a=e.querySelectorAll("h1, h2, h3, h4, h5, h6, p, i, q, a, b, li, span, code, img");for(let e=0;e<a.length;e++){let o=a[e],i=o.getAttribute("data-pass_id");if(l&&l==i)if(o.hasAttribute("raw"))o.textContent=t;else{let e=o.getAttribute("data-collection")?o.getAttribute("data-collection"):c;o.setAttribute("data-collection",e),o.setAttribute("data-document_id",t)}}return e}function selectItemForSelect(e,t){if("single"==(t.hasAttribute("multiple")?"multiple":"single")){t.querySelectorAll(".selected").forEach(function(e){e.remove()})}let l=t.querySelector("input"),c=document.createElement("span");c.innerHTML="x",c.classList.add("remove");let a=e.cloneNode(!0);a.classList.add("selected"),a.classList.remove("selectable"),a.appendChild(c),t.insertBefore(a,l)}function selectValueForSelect(e,t){let l=getSelectValue(t);if(l==e||l.indexOf(e)>-1)return;let c=t.querySelector("input"),a=document.createElement("span");a.innerHTML="x",a.classList.add("remove");let o=document.createElement("li");o.classList.add("selected"),o.setAttribute("data-value",e),o.innerHTML=e,o.appendChild(a),t.insertBefore(o,c)}function getSelectValue(e){let t,l=e.hasAttribute("multiple")?"multiple":"single",c=e.querySelectorAll(".selected");if(c.length>0)if("multiple"==l){t=[];for(let e=0;e<c.length;e++)t.push(c[e].getAttribute("data-value"))}else{t=c[0].getAttribute("data-value")}else t="multiple"==l?[]:"";return t}initCoCreateSelectSockets(),initSortForSelect(),CoCreate.registerSocketInit(initCoCreateSelects,window);var faOBJs=[],faWrapperClass="template-wrapper-array";function initSocketsForFetchArray(){CoCreateSocket.listen("getDocument",function(e){fetchedFA(e)})}function initFetchArrays(){let e=document.querySelectorAll("."+faWrapperClass);for(let t=0;t<e.length;t++){let l=e[t],c=l.id;if(!c)continue;let a=l.getAttribute("data-fetch_collection")?l.getAttribute("data-fetch_collection"):"module_activity",o=l.getAttribute("data-fetch_document_id"),i=l.getAttribute("data-fetch_name");if(!i)continue;let n={eId:c,el:l,templateId:l.getAttribute("data-template_id"),fetch_collection:a,fetch_module_id:o,fetch_name:i,values:[]};faOBJs.push(n),fetchFA(n)}}function fetchFA(e){let t=e.fetch_module_id;CoCreate.getDocument({collection:e.fetch_collection,document_id:t})}function fetchedFA(e){let t=!1;for(let l=0;l<faOBJs.length;l++){let c=faOBJs[l];if(c.fetch_collection==e.collection){if(c.fetch_module_id==e.document_id){let l=e.data[c.fetch_name];l&&JSON.stringify(l)!=JSON.stringify(c.values)&&(c.values=l,showFAResult(c,l),t=!0)}}}t&&CoCreate.fetchModules()}function showFAResult(e,t){let l=e.el.querySelector(".template");if(!l)return;let c=getFAResultTemplate(e.el,t);console.log(c),clearOldItems(e.el),l.insertAdjacentHTML("beforebegin",c.innerHTML),e.el.dispatchEvent(new CustomEvent("fetchedArray"))}function clearOldItems(e){let t=e.getAttribute("data-template_id"),l=e.querySelectorAll("[templateId='"+t+"']");for(let e=0;e<l.length;e++)l[e].remove()}function getFAResultTemplate(e,t){let l=e.getAttribute("data-template_id"),c=e.getAttribute("data-pass_to"),a=document.createElement("div");for(let o=0;o<t.length;o++){let i=t[o],n=document.createElement("div"),r=e.querySelector(".template").cloneNode(!0);r.setAttribute("templateId",l),r.removeAttribute("id"),r.classList.remove("template"),n.appendChild(r.cloneNode(!0));let u=n.querySelectorAll("h1, h2, h3, h4, h5, h6, p, i, q, a, b, li, span, code, img");for(let e=0;e<u.length;e++){let t=u[e],l=t.getAttribute("data-pass_id");c&&c==l&&(t.setAttribute("data-document_id",i),t.hasAttribute("raw")&&(t.textContent=i))}console.log(n.innerHTML),a.insertAdjacentHTML("beforeend",n.innerHTML)}return a}function filterSelectorOptions(e,t){if(e.length)for(let l of e){l.innerText.includes(t)?l.classList.remove("hidden"):l.classList.add("hidden")}}initSocketsForFetchArray(),initFetchArrays(),initCoCreateSelects(document);